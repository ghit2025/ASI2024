#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/prologue" "$@"
[[ $EUID -eq 0 ]] || exit 1

state=${state:-present}
[[ $state == present || $state == absent ]] || exit 2
[[ -n ${vg:-} ]]                           || exit 2
[[ $state == absent || -n ${pvs:-} ]]      || exit 2

pkg_installed lvm2 || exit 3

vg_exists() { vgs --noheadings "$1" &>/dev/null; }

if [[ $state == present ]]; then
    if vg_exists "$vg"; then
        exit 128
    fi
    IFS=',' read -ra devs <<<"$pvs"
    for d in "${devs[@]}"; do
        [[ -b $d ]] || exit 4          # no es dispositivo de bloques
    done
    vgcreate "$vg" "${devs[@]}" &>/dev/null || exit 5
    exit 0
else
    # absent
    if ! vg_exists "$vg"; then
        exit 128
    fi
    vgremove -y "$vg" &>/dev/null || exit 6
    exit 0
fi
