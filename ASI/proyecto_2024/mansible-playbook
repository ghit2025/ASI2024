#!/usr/bin/env bash
set -o pipefail          # sin -e ni -u

[[ $# -eq 1 ]] || { echo "uso: mansible-playbook fichero.play" >&2; exit 1; }
file=$1
[[ -r $file && -f $file ]] || { echo "no puedo leer $file" >&2; exit 2; }

# -------- inventario ----------
read -r inventory < "$file"            # primera línea
[[ -n $inventory ]] || { echo "inventario vacío" >&2; exit 3; }

declare -A ok changed unreachable failed
for h in $inventory; do
    ok[$h]=0; changed[$h]=0; unreachable[$h]=0; failed[$h]=0
done

echo "PLAY [$file] *********************************************"

# -------- tareas (leemos el mismo fichero, saltamos la 1.ª línea) ----------
{
    read                               # descarta la primera línea
    while IFS= read -r line || [[ -n $line ]]; do
        [[ -z $line ]] && continue
        set -- $line                   # divide en palabras
        name=$1; mod=$2; shift 2; args="$*"   # args = resto de la línea
        [[ -x $mod ]] || { echo "TASK [$name] omitida – $mod no ejecutable" >&2; continue; }

        echo; echo "TASK [$name] *********************************************"

        for h in $inventory; do
            if ! ssh -o BatchMode=yes -o ConnectTimeout=3 "$h" true &>/dev/null; then
                echo "unreachable: [$h]"; ((unreachable[$h]++)); continue
            fi
            scp -q "$mod" prologue "$h:/tmp/" || { echo "unreachable: [$h]"; ((unreachable[$h]++)); continue; }

            ssh -n "$h" sudo -n /tmp/"$mod" $args
            rc=$?
            case $rc in
                0)   echo "changed: [$h]"; ((changed[$h]++)); ((ok[$h]++)) ;;
                128) echo "ok: [$h]";      ((ok[$h]++)) ;;
                *)   echo "fatal: [$h]";   ((failed[$h]++)) ;;
            esac
        done
    done
} < "$file"

# -------- recap ----------
echo; echo "PLAY RECAP *********************************************"
for h in $inventory; do
    echo "$h: ok=${ok[$h]} changed=${changed[$h]} unreachable=${unreachable[$h]} failed=${failed[$h]}"
done
